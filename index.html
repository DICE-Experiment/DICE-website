<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DICE â€” Normas & honestidad en 34 paÃ­ses</title>
  <meta name="description" content="DICE: experimento multicountry en aula sobre normas sociales, honestidad y cumplimiento; protocolo comÃºn, datos abiertos y preâ€‘registros." />
  <link rel="canonical" href="https://dice-experiment.github.io/DICE-website/" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0b1225" />

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="DICE â€” Normas & honestidad en 34 paÃ­ses" />
  <meta property="og:description" content="Experimento en aula coordinado en 34 paÃ­ses con protocolo comÃºn, preregistros y datos abiertos." />
  <meta property="og:image" content="https://dice-experiment.github.io/DICE-website/og.png" />
  <meta property="og:url" content="https://dice-experiment.github.io/DICE-website/" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Project",
    "name":"DICE â€” Normas y honestidad",
    "url":"https://dice-experiment.github.io/DICE-website/",
    "description":"Experimento en aula coordinado en 34 paÃ­ses para estudiar normas sociales y honestidad.",
    "creator": {"@type":"Organization","name":"DICE Collaboration"}
  }
  </script>

  <!-- Fonts (with preconnect and swap) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=IBM+Plex+Serif:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <style>
    :root{
      --bg:#0b1225; --surface:#0f172a; --card:#0e162d; --muted:#94a3b8; --text:#e5e7eb;
      --line:#1f2937; --brand:#D49D39; --accent:#193865; --warn:#fbbf24; --chip:#111827;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --brand-rgb:212,157,57; --accent-rgb:25,56,101;
    }
    [data-theme="light"]{
      --bg:#f8fafc; --surface:#ffffff; --card:#f1f5f9; --muted:#64748b; --text:#0f172a;
      --line:#e2e8f0; --brand:#D49D39; --accent:#193865; --warn:#d97706; --chip:#e2e8f0;
      --shadow: 0 4px 12px rgba(0,0,0,.08);
      --brand-rgb:212,157,57; --accent-rgb:25,56,101;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:rgba(212,157,57,.2)}
    html{scroll-behavior:smooth; -webkit-text-size-adjust:100%; -ms-text-size-adjust:100%}
    html,body{margin:0; padding:0; background:var(--bg); color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; min-height:100vh; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}
    a:focus-visible, button:focus-visible{outline:2px solid var(--brand); outline-offset:2px; border-radius:4px}
    a:focus:not(:focus-visible){outline:none}
    button{font-family:inherit; font-size:inherit}
    input, select, textarea{font-family:inherit; font-size:inherit; line-height:inherit}
    .skip{position:absolute; left:-9999px}
    .skip:focus{left:12px; top:12px; background:#000; color:#fff; padding:8px 10px; border-radius:8px; z-index:50}
    img{max-width:100%; height:auto}
    .container{max-width:1200px; margin:0 auto; padding:0 20px}
    .nav{position:sticky; top:0; z-index:1200; background:rgba(10,15,30,.95); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); border-bottom:1px solid var(--line)}
    [data-theme="light"] .nav{background:rgba(248,250,252,.95); color:var(--text)}
    .nav-inner{display:flex; align-items:center; justify-content:space-between; padding:12px 0; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; white-space:nowrap; flex-shrink:0}
    .brand .small{font-size:10px !important; display:inline-block; max-width:180px}
    .logo{width:40px; height:40px; display:flex; align-items:center; justify-content:center;}
    .logo img{width:100%; height:100%; object-fit:contain;}
    .tabs{display:flex; gap:6px; flex-wrap:nowrap; flex-shrink:1}
    .tabs a{padding:8px 10px; background:var(--chip); border:1px solid var(--line); border-radius:10px; font-size:13px; transition:all .2s ease; text-decoration:none; min-height:36px; display:inline-flex; align-items:center; justify-content:center; white-space:nowrap}
    .tabs a:hover{border-color:var(--brand); transform:translateY(-1px); -webkit-transform:translateY(-1px); box-shadow:0 2px 8px rgba(212,157,57,.3); text-decoration:none}
    .tabs a:active{transform:translateY(0); -webkit-transform:translateY(0)}
    .hero{padding:80px 0 40px; position:relative; overflow:hidden}
    .glow{position:absolute; inset:-30% -10% auto -10%; height:420px;
          background:radial-gradient(550px 300px at 20% 20%, rgba(25,56,101,.25), transparent 60%),
                     radial-gradient(500px 260px at 80% 30%, rgba(212,157,57,.15), transparent 60%),
                     radial-gradient(600px 300px at 50% 100%, rgba(212,157,57,.1), transparent 60%); filter:blur(40px); z-index:-1}
    [data-theme="light"] .glow{background:radial-gradient(550px 300px at 20% 20%, rgba(25,56,101,.12), transparent 60%),
                     radial-gradient(500px 260px at 80% 30%, rgba(212,157,57,.1), transparent 60%),
                     radial-gradient(600px 300px at 50% 100%, rgba(212,157,57,.08), transparent 60%)}
    h1,h2,h3,h4,h5,h6{font-family:'IBM Plex Serif',serif; font-weight:700; letter-spacing:-0.02em}
    [data-theme="light"] h1, [data-theme="light"] h2{color:var(--accent)}
    h1{font-size:42px; margin:10px 0 8px}
    .sub{color:var(--muted); font-size:18px; max-width:900px}
    .chips{display:flex; gap:12px; flex-wrap:wrap; margin-top:20px}
    .chip{background:var(--chip); border:1px solid var(--line); padding:10px 16px; border-radius:999px; font-size:15px; font-weight:500; transition:all .2s; min-height:40px; display:inline-flex; align-items:center; justify-content:center}
    a.chip{color:var(--text); text-decoration:none}
    a.chip:hover{border-color:var(--brand); transform:translateY(-2px); -webkit-transform:translateY(-2px); box-shadow:0 4px 12px rgba(212,157,57,.4)}
    a.chip:active{transform:translateY(0); -webkit-transform:translateY(0)}
    section{padding:50px 0; border-top:1px solid var(--line)}
    h2{font-size:28px; margin:0 0 16px}
    h3{margin-top:0}
    .two-col{display:grid; grid-template-columns:1.15fr .85fr; gap:22px}
    .two-col.equal{grid-template-columns:1fr 1fr}
    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:22px; box-shadow:var(--shadow)}
    a.card-link{text-decoration:none; color:var(--text); display:block; transition:all .2s; cursor:pointer}
    a.card-link:hover{transform:translateY(-2px); border-color:var(--brand); box-shadow:0 8px 24px rgba(212,157,57,.3)}
    .list{display:grid; gap:10px}
    .list .item{display:flex; gap:12px; align-items:flex-start; background:var(--surface); border:1px solid var(--line); padding:12px 14px; border-radius:12px}
    .bullet{width:8px; height:8px; border-radius:50%; background:var(--brand); margin-top:8px}
    .grid{display:grid; gap:16px}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    @media (max-width:1300px){
      .tabs a{padding:8px 8px; font-size:12px}
      .brand .small{font-size:9px !important; max-width:160px}
    }
    @media (max-width:980px){
      .two-col{grid-template-columns:1fr}
      .two-col.equal{grid-template-columns:1fr}
      .cols-3{grid-template-columns:repeat(2,1fr)}
      .cols-4{grid-template-columns:repeat(2,1fr)}
      .brand .small{font-size:9px !important}
      .tabs{flex-wrap:wrap}
      h1{font-size:36px}
      h2{font-size:24px}
    }
    @media (max-width:640px){
      .cols-3,.cols-4{grid-template-columns:1fr}
      h1{font-size:28px; line-height:1.2}
      h2{font-size:22px}
      h3{font-size:18px}
      .container{padding:0 16px}
      .hero{padding:50px 0 30px}
      section{padding:40px 0}
      .card{padding:18px}
      .btn{width:100%; text-align:center; padding:12px 16px; display:flex}
      .btn + .btn{margin-top:8px}
      .chip{font-size:13px; padding:8px 12px; min-height:36px}
      #map{height:350px; border-radius:8px}
      .tabs a{flex:1 1 auto; text-align:center; padding:10px 8px; min-height:44px}
      .lang-btn{padding:8px 10px; min-height:40px}
      .sub{font-size:16px}
      .logo{font-size:28px}
      .brand{font-size:16px}
      /* Better scrollable area on mobile */
      .card > div[style*="max-height"]{max-height:300px !important}
    }

    /* Extra small devices */
    @media (max-width:360px){
      h1{font-size:24px}
      h2{font-size:20px}
      .container{padding:0 12px}
      .card{padding:14px}
    }
    .proj{background:var(--surface); border:1px solid var(--line); border-radius:16px; padding:18px}
    .proj h4{margin:0 0 6px}
    .tag{display:inline-block; padding:6px 10px; background:var(--chip); border:1px solid var(--line); border-radius:999px; font-size:12px; margin-right:6px}
    .gallery{display:grid; grid-template-columns:repeat(6,1fr); gap:8px}
    .gallery img{width:100%; height:120px; object-fit:cover; border-radius:10px; border:1px solid var(--line)}
    @media (max-width:980px){ .gallery{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:640px){ .gallery{grid-template-columns:repeat(2,1fr)} }
    footer{padding:40px 0; color:var(--muted)}
    .small{font-size:12px; color:var(--muted)}
    .btn{display:inline-block; padding:10px 14px; border-radius:10px; background:var(--brand); color:#04101f; font-weight:700; border:1px solid transparent; transition:all .2s ease; cursor:pointer; text-decoration:none; min-height:44px; display:inline-flex; align-items:center; justify-content:center; -webkit-user-select:none; user-select:none}
    .btn:hover{transform:translateY(-1px); -webkit-transform:translateY(-1px); box-shadow:0 4px 12px rgba(96,165,250,.4); text-decoration:none}
    .btn:active{transform:translateY(0); -webkit-transform:translateY(0)}
    .btn.secondary{background:transparent; border:1px solid var(--brand); color:var(--brand)}
    .btn.secondary:hover{background:rgba(96,165,250,.1); transform:translateY(-1px); -webkit-transform:translateY(-1px); box-shadow:0 4px 12px rgba(96,165,250,.2)}
    .lang-btn{display:flex; gap:2px; padding:4px 6px; background:var(--chip); border:1px solid var(--line); border-radius:10px; cursor:pointer; font-size:12px; font-weight:600; transition:border-color .2s; min-height:36px; align-items:center}
    .lang-btn:hover{border-color:var(--brand)}
    .lang-option{padding:4px 6px; border-radius:6px; color:var(--muted); transition:all .2s}
    .lang-option.active{background:var(--brand); color:#fff; font-weight:600}
    #map{width:100%; height:500px; border-radius:12px; overflow:hidden}
    .map-legend{display:flex; justify-content:center; margin-top:20px; gap:20px}
    .legend-item{display:flex; align-items:center; gap:8px}
    .legend-dot{width:12px; height:12px; border-radius:50%; background:var(--brand); border:2px solid var(--accent)}
    .leaflet-container{background:var(--surface); font-family:Inter,sans-serif}
    /* Remove tile tint to avoid over-darkening */
    .leaflet-tile-pane{filter:none}
    .leaflet-container a.leaflet-popup-close-button{color:var(--text)}
    .leaflet-popup-content-wrapper{background:var(--card); color:var(--text); border-radius:8px}
    .leaflet-popup-tip{background:var(--card)}
    .leaflet-tooltip.country-tooltip{background:var(--card); color:var(--text); border:2px solid var(--brand); border-radius:12px; padding:12px 14px; font-size:13px; box-shadow:0 8px 24px rgba(0,0,0,0.4); max-width:350px; line-height:1.4}
    .leaflet-tooltip.country-tooltip::before{border-top-color:var(--brand) !important}

    /* Custom zoom controls - black background with white symbols */
    .leaflet-control-zoom a{background:#000 !important; color:#fff !important; border:1px solid #333 !important}
    .leaflet-control-zoom a:hover{background:#1a1a1a !important; border-color:#555 !important}

    /* Custom scrollbar styling for webkit browsers */
    ::-webkit-scrollbar{width:8px; height:8px}
    ::-webkit-scrollbar-track{background:var(--surface); border-radius:4px}
    ::-webkit-scrollbar-thumb{background:var(--line); border-radius:4px; border:1px solid var(--surface)}
    ::-webkit-scrollbar-thumb:hover{background:var(--brand)}

    /* Improve momentum scrolling on iOS */
    .card > div[style*="overflow-y"]{-webkit-overflow-scrolling:touch; overflow-y:auto}

    /* Improved card transitions */
    .card{transition:all .3s ease}

    /* Reduced motion - accessibility */
    @media (prefers-reduced-motion: reduce){
      *{animation-duration:0.01ms !important; animation-iteration-count:1 !important; transition-duration:0.01ms !important; scroll-behavior:auto !important}
      .tabs a:hover, a.chip:hover, .btn:hover{transform:none !important; -webkit-transform:none !important}
    }

    /* High contrast mode support */
    @media (prefers-contrast: high){
      .card{border-width:2px}
      .btn{border-width:2px}
    }

    /* Print styles */
    @media print{
      .nav, .lang-btn, .btn, .chip{display:none}
      body{background:#fff; color:#000}
      .card{border:1px solid #000; box-shadow:none}
      a{color:#000; text-decoration:underline}
    }

    /* Toast notifications */
    .toast{position:fixed; top:50%; left:50%; background:#10b981; color:#04101f; padding:12px 16px; border-radius:12px; box-shadow:var(--shadow); font-weight:700; z-index:1000; opacity:0; transform:translate(-50%, -12px); transition:opacity .2s, transform .2s}
    .toast.show{opacity:1; transform:translate(-50%, 0)}
  </style>
</head>
<body>
<a href="#main" class="skip">Saltar al contenido</a>

<!-- NAV -->
<div class="nav" role="navigation" aria-label="principal">
  <div class="container nav-inner">
    <a href="#bienvenida" class="brand" style="text-decoration:none; color:inherit;">
      <div class="logo" aria-hidden="true"><img src="logo.png" alt="DICE Logo"></div>
      <div>DICE â€” <span class="small" data-i18n="nav.subtitle">Experimento multicultural en aula</span></div>
    </a>
    <nav class="tabs">
      <a href="#implementacion" data-i18n-nav="implementation">ImplementaciÃ³n</a>
      <a href="#colaboradores" data-i18n-nav="collaborators">Colaboradores</a>
      <a href="#proyectos" data-i18n-nav="projects">Proyectos</a>
      <a href="#datos" data-i18n-nav="data">Datos</a>
      <a href="#cuestionario" data-i18n-nav="prereg">Preâ€‘registros</a>
      <a href="#fotos" data-i18n-nav="photos">Fotos</a>
      <button id="theme-toggle" class="lang-btn" aria-label="Change theme">
        <span class="lang-option" data-theme-opt="dark">ğŸŒ™</span>
        <span class="lang-option" data-theme-opt="light">â˜€ï¸</span>
        <span class="lang-option active" data-theme-opt="auto">Auto</span>
      </button>
      <button id="lang-toggle" class="lang-btn" aria-label="Change language">
        <span class="lang-option" data-lang="en">EN</span>
        <span class="lang-option active" data-lang="es">ES</span>
      </button>
    </nav>
  </div>
</div>

<!-- HERO -->
<header id="bienvenida" class="hero">
  <div class="glow" aria-hidden="true"></div>
  <div class="container">
    <h1 data-i18n="hero.title">Proyecto DICE</h1>
    <p class="sub" data-i18n="hero.subtitle">
      Un experimento en aula, coordinado y armonizado, realizado en <strong><span id="hero-country-count">34</span> paÃ­ses</strong> para estudiar normas sociales y honestidad.
      La base de datos comÃºn alimenta <strong>14 proyectos</strong> que analizan mecanismos complementarios (capital cÃ­vico, confianza institucional, preferencias sociales y cumplimiento).
    </p>
    <div class="chips" aria-label="caracterÃ­sticas">
      <a href="#paises" class="chip"><span id="chip-country-count">34</span> paÃ­ses</a>
      <a href="#proyectos" class="chip" data-i18n="hero.chip5">14 proyectos vinculados</a>
      <a href="#implementacion" class="chip" data-i18n="hero.chip3">Protocolo comÃºn</a>
      <a href="#datos" class="chip" data-i18n="hero.chip4">Materiales abiertos</a>
    </div>
  </div>
</header>

<main id="main">
  <!-- PAÃSES -->
  <section id="paises">
    <div class="container">
      <h2><span id="section-country-count">34</span> <span data-i18n="countries.titleSuffix">PaÃ­ses participantes</span></h2>
      <p class="sub" data-i18n="countries.subtitle">Red global de investigaciÃ³n con representaciÃ³n en 5 continentes.</p>
      <div class="card" style="margin-top:20px; background:var(--surface); padding:30px">
        <div id="map"></div>
        <div class="map-legend">
          <div class="legend-item">
            <span class="legend-dot"></span>
            <span class="small" data-i18n="countries.legend">PaÃ­ses participantes (34)</span>
          </div>
        </div>
        <p class="small" style="margin-top:16px; text-align:center" data-i18n="countries.note">
          Cobertura en AmÃ©rica, Europa, Asia, Ãfrica y OceanÃ­a
        </p>
      </div>
    </div>
  </section>

  <!-- IMPLEMENTACIÃ“N -->
  <section id="implementacion">
    <div class="container two-col">
      <div class="card">
        <h2 data-i18n="implementation.title">Resumen de implementaciÃ³n</h2>
        <div class="list">
          <div class="item"><div class="bullet" aria-hidden="true"></div><div data-i18n="implementation.item1"><strong>DiseÃ±o:</strong> Tarea del dado en aula con instrucciones armonizadas, supervisiÃ³n y tiempos estandarizados.</div></div>
          <div class="item"><div class="bullet" aria-hidden="true"></div><div data-i18n="implementation.item2"><strong>Muestra:</strong> Clases universitarias; N objetivo por paÃ­s segÃºn protocolo (sustituir con tus cifras).</div></div>
          <div class="item"><div class="bullet" aria-hidden="true"></div><div data-i18n="implementation.item3"><strong>Medidas clave:</strong> Reporte de resultados, proxies de honestidad, normas sociales, confianza, conductas cÃ­vicas y demografÃ­a.</div></div>
          <div class="item"><div class="bullet" aria-hidden="true"></div><div data-i18n="implementation.item4"><strong>Calidad:</strong> Preâ€‘registro, checklist de proctor, marcas de tiempo y validaciÃ³n centralizada.</div></div>
          <div class="item"><div class="bullet" aria-hidden="true"></div><div data-i18n="implementation.item5"><strong>Datos:</strong> Liberaciones por etapas (piloto â†’ v1.0 â†’ replicaciÃ³n) con guÃ­a de licencia y citaciÃ³n.</div></div>
        </div>
      </div>
      <aside class="card" aria-labelledby="accesos-rapidos">
        <h3 id="accesos-rapidos" data-i18n="implementation.quickLinks">Accesos rÃ¡pidos</h3>
        <div class="list">
          <div class="item"><div class="bullet" aria-hidden="true"></div><div><a href="#cuestionario" data-i18n="implementation.link1">Vista previa del cuestionario</a></div></div>
          <div class="item"><div class="bullet" aria-hidden="true"></div><div><a href="#cuestionario" data-i18n="implementation.link2">Registro de preâ€‘anÃ¡lisis</a></div></div>
          <div class="item"><div class="bullet" aria-hidden="true"></div><div><a href="#proyectos" data-i18n="implementation.link3">Listado de proyectos</a></div></div>
          <div class="item"><div class="bullet" aria-hidden="true"></div><div><a href="#" data-i18n="implementation.link4">Paquete de replicaciÃ³n (placeholder)</a></div></div>
        </div>
        <p class="small" style="margin-top:8px" data-i18n="implementation.note">Sustituye los <em>placeholders</em> por enlaces a OSF/AEA/Dataverse/GitHub.</p>
      </aside>
    </div>
  </section>

  <!-- COLABORADORES -->
  <section id="colaboradores">
    <div class="container">
      <h2 data-i18n="collaborators.title">Colaboradores</h2>
      <p class="sub" data-i18n="collaborators.subtitle">Red global de investigadores/as, docentes y asistentes. AÃ±ade logotipos, nombres, roles e instituciones.</p>
      <div class="grid cols-4" style="margin-top:16px">
        <div class="card">
          <h3 data-i18n="collaborators.card1.title">CoordinaciÃ³n</h3>
          <p data-i18n="collaborators.card1.text">Investigador principal: <strong><a href="https://www.ub.edu/school-economics/researchers/exadaktylos-filippos/" target="_blank" style="color:inherit; text-decoration:none">Filippos Exadaktylos</a></strong> (ejemplo)</p>
          <p class="small" data-i18n="collaborators.card1.note">AÃ±ade coâ€‘IPs, gestiÃ³n de proyecto y contactos.</p>
        </div>
        <a href="countries.html" class="card card-link">
          <h3 data-i18n="collaborators.card2.title">Equipos por paÃ­s</h3>
          <p data-i18n="collaborators.card2.text">Una tarjeta por paÃ­s con instituciÃ³n, PI(s), ciudad, nivel educativo y tamaÃ±o muestral.</p>
          <p class="small" style="margin-top:12px; color:var(--brand)" data-i18n="collaborators.card2.viewall">â†’ Ver todos los 34 paÃ­ses</p>
        </a>
        <div class="card">
          <h3 data-i18n="collaborators.card3.title">MÃ©todos & QA</h3>
          <p data-i18n="collaborators.card3.text">Autores del protocolo, arquitectura de encuesta y equipo de auditorÃ­a de datos.</p>
          <span class="tag" data-i18n="collaborators.card3.tag1">Protocolo</span>
          <span class="tag" data-i18n="collaborators.card3.tag2">Encuesta</span>
          <span class="tag" data-i18n="collaborators.card3.tag3">AuditorÃ­a</span>
        </div>
        <div class="card">
          <h3 data-i18n="collaborators.card4.title">Socios & financiadores</h3>
          <p data-i18n="collaborators.card4.text">Incluye nÃºmeros de beca, patrocinadores y alianzas institucionales.</p>
          <span class="tag">Grant #</span>
          <span class="tag">Partner</span>
        </div>
      </div>
    </div>
  </section>

  <!-- PROYECTOS -->
  <section id="proyectos">
    <div class="container">
      <h2 id="projects-title">Projects (<span id="project-count">Loading...</span>)</h2>
      <p class="sub" data-i18n="projects.subtitle">Cada proyecto aprovecha una parte distinta del dataset comÃºn. A continuaciÃ³n, resÃºmenes breves y enlaces clave.</p>
      <div id="projects-grid" class="grid cols-3" style="margin-top:16px">
        <!-- Projects will be loaded dynamically from projects-data.json -->
        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #64748b;">
          <div style="font-size: 14px;">Loading projects...</div>
        </div>
      </div>
    </div>
  </section>

  <!-- DATOS -->
  <section id="datos">
    <div class="container">
      <h2 data-i18n="data.title">Datos</h2>
      <p class="sub" data-i18n="data.subtitle">Accede a nuestros datos de muestra del experimento DICE. Datos completos disponibles tras publicaciÃ³n.</p>
      <div class="grid cols-2" style="margin-top:16px">
        <div class="card">
          <h3 data-i18n="data.card1.title">Datos de muestra</h3>
          <p data-i18n="data.card1.desc">Dataset de ejemplo con 15 participantes de 5 paÃ­ses. Incluye resultados del dado, datos demogrÃ¡ficos y puntuaciones de confianza.</p>
          <p class="small" style="margin-top:12px">
            <strong data-i18n="data.card1.format">Formato:</strong> CSV<br/>
            <strong data-i18n="data.card1.size">TamaÃ±o:</strong> ~1 KB<br/>
            <strong data-i18n="data.card1.updated">Actualizado:</strong> 2024-03-25
          </p>
          <p style="margin-top:16px">
            <a class="btn" href="data/general/sample-full-data.csv" download data-i18n="data.card1.btn">Descargar datos de muestra</a>
          </p>
        </div>
        <div class="card">
          <h3 data-i18n="data.card2.title">Estructura de datos</h3>
          <p data-i18n="data.card2.desc">El dataset incluye las siguientes variables:</p>
          <ul style="margin-top:8px">
            <li><code>country</code> â€” <span data-i18n="data.card2.var1">PaÃ­s del participante</span></li>
            <li><code>participant_id</code> â€” <span data-i18n="data.card2.var2">ID Ãºnico</span></li>
            <li><code>dice_roll</code> â€” <span data-i18n="data.card2.var3">Resultado real del dado</span></li>
            <li><code>reported_value</code> â€” <span data-i18n="data.card2.var4">Valor reportado</span></li>
            <li><code>session_date</code> â€” <span data-i18n="data.card2.var5">Fecha de sesiÃ³n</span></li>
            <li><code>age</code> â€” <span data-i18n="data.card2.var6">Edad</span></li>
            <li><code>gender</code> â€” <span data-i18n="data.card2.var7">GÃ©nero</span></li>
            <li><code>trust_score</code> â€” <span data-i18n="data.card2.var8">PuntuaciÃ³n de confianza (1-10)</span></li>
          </ul>
        </div>
      </div>
      <div class="card" style="margin-top:16px">
        <h3 data-i18n="data.card3.title">Acceso al dataset completo</h3>
        <p data-i18n="data.card3.text">El dataset completo con datos de los 34 paÃ­ses estarÃ¡ disponible tras la publicaciÃ³n de los artÃ­culos principales. Se alojarÃ¡ en repositorios abiertos con DOI y licencia Creative Commons.</p>
        <p class="small" style="margin-top:8px" data-i18n="data.card3.note">Para acceso anticipado o colaboraciones, contacta al <a href="https://www.ub.edu/school-economics/researchers/exadaktylos-filippos/" target="_blank" style="color:#60a5fa; text-decoration:none">equipo de coordinaciÃ³n</a>.</p>
      </div>
    </div>
  </section>

  <!-- CUESTIONARIO -->
  <section id="cuestionario">
    <div class="container two-col equal">
      <aside id="questionaries-box" class="card">
        <h3 data-i18n="questionnaire.docsTitle">Individual questionnaires</h3>
        <p class="small" style="margin-bottom:12px">
          <a id="download-all-questionnaires" class="btn" href="#" rel="noopener" data-i18n="questionnaire.btn2">Download all Questionnaires</a>
        </p>
        <div style="max-height: 400px; overflow-y: auto; margin: 16px 0; padding-right: 8px;">
          <a href="data/countries/argentina/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¦ğŸ‡· Argentina</a>
          <a href="data/countries/austria/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¦ğŸ‡¹ Austria</a>
          <a href="data/countries/chile/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¨ğŸ‡± Chile</a>
          <a href="data/countries/china/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¨ğŸ‡³ China</a>
          <a href="data/countries/cotedivoire/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¨ğŸ‡® CÃ´te d'Ivoire</a>
          <a href="data/countries/congo/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¨ğŸ‡© D.R. Congo</a>
          <a href="data/countries/colombia/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¨ğŸ‡´ Colombia</a>
          <a href="data/countries/czechia/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¨ğŸ‡¿ Czech Republic</a>
          <a href="data/countries/germany/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡©ğŸ‡ª Germany</a>
          <a href="data/countries/egypt/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡ªğŸ‡¬ Egypt</a>
          <a href="data/countries/spain/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡ªğŸ‡¸ Spain</a>
          <a href="data/countries/france/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡«ğŸ‡· France</a>
          <a href="data/countries/uk/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¬ğŸ‡§ United Kingdom</a>
          <a href="data/countries/greece/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¬ğŸ‡· Greece</a>
          <a href="data/countries/hongkong/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡­ğŸ‡° Hong Kong</a>
          <a href="data/countries/hungary/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡­ğŸ‡º Hungary</a>
          <a href="data/countries/italy/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡®ğŸ‡¹ Italy</a>
          <a href="data/countries/japan/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¯ğŸ‡µ Japan</a>
          <a href="data/countries/kazakhstan/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡°ğŸ‡¿ Kazakhstan</a>
          <a href="data/countries/korea/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡°ğŸ‡· South Korea</a>
          <a href="data/countries/madagascar/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡²ğŸ‡¬ Madagascar</a>
          <a href="data/countries/pakistan/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡µğŸ‡° Pakistan</a>
          <a href="data/countries/peru/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡µğŸ‡ª Peru</a>
          <a href="data/countries/philippines/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡µğŸ‡­ Philippines</a>
          <a href="data/countries/poland/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡µğŸ‡± Poland</a>
          <a href="data/countries/portugal/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡µğŸ‡¹ Portugal</a>
          <a href="data/countries/qatar/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¶ğŸ‡¦ Qatar</a>
          <a href="data/countries/russia/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡·ğŸ‡º Russia</a>
          <a href="data/countries/saudi/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¸ğŸ‡¦ Saudi Arabia</a>
          <a href="data/countries/singapore/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¸ğŸ‡¬ Singapore</a>
          <a href="data/countries/turkey/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¹ğŸ‡· Turkey</a>
          <a href="data/countries/taiwan/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡¹ğŸ‡¼ Taiwan</a>
          <a href="data/countries/uruguay/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡ºğŸ‡¾ Uruguay</a>
          <a href="data/countries/usa/questionnaire.pdf" download class="btn secondary" style="display: block; margin-bottom: 8px; font-size: 13px; padding: 8px 12px;">ğŸ‡ºğŸ‡¸ United States</a>
        </div>
        <p class="small" data-i18n="questionnaire.docsNote">Descarga cuestionarios por paÃ­s.</p>
      </aside>
      <div id="prereg-box" class="card">
        <h3 data-i18n="prereg.title">Preâ€‘registros</h3>
        <p class="small" style="margin-bottom:12px">
          <a id="download-all-prereg" class="btn" href="#" rel="noopener" data-i18n="prereg.btnAll">Download all preregistrations</a>
        </p>
        <div id="prereg-list" style="max-height: 400px; overflow-y: auto; margin: 16px 0; padding-right: 8px;">
          <!-- Preregistration links will be loaded dynamically from projects-data.json -->
          <div style="text-align: center; padding: 20px; color: var(--muted);">Loading preregistrations...</div>
    </div>
      </div>
    </div>
  </section>


  <!-- FOTOS -->
  <section id="fotos">
    <div class="container">
      <h2 data-i18n="photos.title">Fotos</h2>
      <p class="sub" data-i18n="photos.subtitle">Sustituye con imÃ¡genes de aulas, talleres y equipos. (Marcadores de Picsum).</p>
      <div class="gallery" style="margin-top:12px">
        <img src="https://picsum.photos/id/1011/600/400" alt="Aula universitaria 1" loading="lazy" decoding="async" />
        <img src="https://picsum.photos/id/1025/600/400" alt="Actividad en clase 2" loading="lazy" decoding="async" />
        <img src="https://picsum.photos/id/1035/600/400" alt="Vista de campus 3" loading="lazy" decoding="async" />
        <img src="https://picsum.photos/id/1044/600/400" alt="Estudiantes 4" loading="lazy" decoding="async" />
        <img src="https://picsum.photos/id/1050/600/400" alt="Taller 5" loading="lazy" decoding="async" />
        <img src="https://picsum.photos/id/1062/600/400" alt="Seminario 6" loading="lazy" decoding="async" />
        <img src="https://picsum.photos/id/1074/600/400" alt="Equipo de investigaciÃ³n 7" loading="lazy" decoding="async" />
        <img src="https://picsum.photos/id/1084/600/400" alt="Encuentro 8" loading="lazy" decoding="async" />
        <img src="https://picsum.photos/id/1080/600/400" alt="Participantes 9" loading="lazy" decoding="async" />
        <img src="https://picsum.photos/id/1015/600/400" alt="Aula universitaria 10" loading="lazy" decoding="async" />
        <img src="https://picsum.photos/id/1016/600/400" alt="Aula universitaria 11" loading="lazy" decoding="async" />
        <img src="https://picsum.photos/id/1019/600/400" alt="Aula universitaria 12" loading="lazy" decoding="async" />
      </div>
    </div>
  </section>
</main>

<!-- FOOTER -->
<footer>
  <div class="container">
    <div class="grid cols-3">
      <div>
        <strong>DICE</strong><br/><span class="small" data-i18n="footer.tagline">Normas & honestidad en 34 paÃ­ses</span>
      </div>
      <div>
        <span class="small" data-i18n="footer.contact">Contacto</span><br/>
        <a href="mailto:dice-experiment@example.org" class="small">diceâ€‘experiment@example.org</a>
      </div>
      <div>
        <span class="small" data-i18n="footer.status">Estado del sitio</span><br/>
        <span class="small"><span data-i18n="footer.updated">Ãšltima actualizaciÃ³n:</span> <time id="last-updated" aria-live="polite"></time></span><br/>
        <span class="small" style="color:var(--brand); font-weight:600; margin-top:4px; display:inline-block;">Version: <span id="data-version">2025.11.11.v25</span></span>
      </div>
    </div>
  </div>
</footer>

<script>
  // Translations
  const translations = {
    en: {
      nav: {
        subtitle: 'Multicultural classroom experiments',
        welcome: 'Welcome',
        implementation: 'Implementation',
        collaborators: 'Collaborators',
        projects: 'Projects',
        data: 'Data',
        photos: 'Photos',
        questionnaire: 'Questionnaires',
        prereg: 'Pre-registrations'
      },
      hero: {
        title: 'DICE Project',
        subtitle: 'A coordinated and harmonized classroom experiment conducted in <strong>34 countries</strong> to study social norms and honesty. The shared database feeds <strong>14 projects</strong> that analyze complementary mechanisms (civic capital, institutional trust, social preferences, and compliance).',
        chip1: 'In-class',
        chip2: '34 countries',
        chip3: 'Common protocol',
        chip4: 'Open materials',
        chip5: '14 linked projects',
        kpi1: 'Countries',
        kpi2: 'Linked projects',
        kpi3: 'Dataset & protocol'
      },
      countries: {
        title: '34 Participating Countries',
        titleSuffix: 'Participating Countries',
        subtitle: 'Global research network with representation across 5 continents.',
        ARG: 'Argentina', AUT: 'Austria', CHL: 'Chile', CHN: 'China', CIV: 'CÃ´te d\'Ivoire',
        COD: 'D.R. Congo', COL: 'Colombia', CZE: 'Czech Republic', DEU: 'Germany', EGY: 'Egypt',
        ESP: 'Spain', FRA: 'France', GBR: 'United Kingdom', GRC: 'Greece', HKG: 'Hong Kong',
        HUN: 'Hungary', ITA: 'Italy', JPN: 'Japan', KAZ: 'Kazakhstan', KOR: 'South Korea',
        MDG: 'Madagascar', PAK: 'Pakistan', PER: 'Peru', PHL: 'Philippines', POL: 'Poland',
        PRT: 'Portugal', QAT: 'Qatar', RUS: 'Russia', SAU: 'Saudi Arabia', SGP: 'Singapore',
        TUR: 'Turkey', TWN: 'Taiwan', URY: 'Uruguay', USA: 'United States',
        legend: 'Participating countries (34)',
        note: 'Coverage across America, Europe, Asia, Africa, and Oceania'
      },
      countryDetails: {
        title: 'Country Teams',
        subtitle: 'Detailed information about each participating research team.',
        team: 'Team:',
        institution: 'Institution:',
        city: 'City:',
        sample: 'Sample:',
        observations: 'Observations:'
      },
      implementation: {
        title: 'Implementation Summary',
        item1: '<strong>Design:</strong> Classroom dice task with harmonized instructions, supervision, and standardized timing.',
        item2: '<strong>Sample:</strong> University classes; target N per country according to protocol (replace with your figures).',
        item3: '<strong>Key measures:</strong> Outcome reporting, honesty proxies, social norms, trust, civic behaviors, and demographics.',
        item4: '<strong>Quality:</strong> Pre-registration, proctor checklist, timestamps, and centralized validation.',
        item5: '<strong>Data:</strong> Phased releases (pilot â†’ v1.0 â†’ replication) with license and citation guide.',
        quickLinks: 'Quick Links',
        link1: 'Questionnaire preview',
        link2: 'Pre-analysis registry',
        link3: 'Project list',
        link4: 'Replication package (placeholder)',
        note: 'Replace <em>placeholders</em> with links to OSF/AEA/Dataverse/GitHub.'
      },
      collaborators: {
        title: 'Collaborators',
        subtitle: 'Global network of researchers, instructors, and assistants. Add logos, names, roles, and institutions.',
        card1: {
          title: 'Coordination',
          text: 'Principal investigator: <strong><a href="https://www.ub.edu/school-economics/researchers/exadaktylos-filippos/" target="_blank" style="color:inherit; text-decoration:none">Filippos Exadaktylos</a></strong> (example)',
          note: 'Add co-PIs, project management, and contacts.'
        },
        card2: {
          title: 'Country teams',
          text: 'One card per country with institution, PI(s), city, educational level, and sample size.',
          viewall: 'â†’ View all 34 countries'
        },
        card3: {
          title: 'Methods & QA',
          text: 'Protocol authors, survey architecture, and data audit team.',
          tag1: 'Protocol',
          tag2: 'Survey',
          tag3: 'Audit'
        },
        card4: {
          title: 'Partners & funders',
          text: 'Include grant numbers, sponsors, and institutional partnerships.'
        }
      },
      projects: {
        title: 'Projects (14)',
        subtitle: 'Each project leverages a different part of the shared dataset. Below are brief summaries and key links.',
        p1: { title: '1. Social norms & reporting', desc: 'Relationship between perceived norms/meta-beliefs and behavior in the dice task.' },
        p2: { title: '2. Civic capital & trust', desc: 'Civic behaviors, institutional trust, and honesty across cultures.' },
        p3: { title: '3. Compliance & policy', desc: 'Rule acceptance and compliance correlates.' },
        p4: { title: '4. Cultural dimensions', desc: 'Individualism, universalism, and norm-following.' },
        p5: { title: '5. Institutions & honesty', desc: 'Institutional quality and interactions with honesty proxies.' },
        p6: { title: '6. Inequality & justice', desc: 'Distributive preferences and rule compliance.' },
        p7: { title: '7. Education & cohorts', desc: 'Differences by age and educational level.' },
        p8: { title: '8. Urban vs. regional', desc: 'Geography, institution type, and norms.' },
        p9: { title: '9. Gender & norms', desc: 'Gender expectations and honesty.' },
        p10: { title: '10. Replication & methods', desc: 'Power, identification, and robustness across countries.' },
        p11: { title: '11. Messages & beliefs', desc: 'Informational treatments and norm updating.' },
        p12: { title: '12. Networks & spillovers', desc: 'Peer effects in the classroom.' },
        p13: { title: '13. Ethics & consent', desc: 'Ethical approvals and consent language.' },
        p14: { title: '14. Data curation', desc: 'Documentation standardization and versioning.' },
        tag: {
          analysis: 'Analysis plan',
          materials: 'Materials',
          code: 'Code',
          prereg: 'Pre-reg',
          slides: 'Slides',
          design: 'Design',
          results: 'Results',
          guide: 'Guide'
        }
      },
      data: {
        title: 'Data',
        subtitle: 'Access our sample data from the DICE experiment. Full dataset available after publication.',
        card1: {
          title: 'Sample data',
          desc: 'Sample dataset with 15 participants from 5 countries. Includes dice outcomes, demographics, and trust scores.',
          format: 'Format:',
          size: 'Size:',
          updated: 'Updated:',
          btn: 'Download sample data'
        },
        card2: {
          title: 'Data structure',
          desc: 'The dataset includes the following variables:',
          var1: 'Participant country',
          var2: 'Unique ID',
          var3: 'Actual dice roll',
          var4: 'Reported value',
          var5: 'Session date',
          var6: 'Age',
          var7: 'Gender',
          var8: 'Trust score (1-10)'
        },
        card3: {
          title: 'Full dataset access',
          text: 'The complete dataset with data from all 34 countries will be available after publication of the main papers. It will be hosted in open repositories with DOI and Creative Commons license.',
          note: 'For early access or collaborations, contact the <a href="https://www.ub.edu/school-economics/researchers/exadaktylos-filippos/" target="_blank" style="color:#60a5fa; text-decoration:none">coordination team</a>.'
        }
      },
      photos: {
        title: 'Photos',
        subtitle: 'Replace with images of classrooms, workshops, and teams. (Picsum placeholders).'
      },
      questionnaire: {
        title: 'Questionnaire (preview)',
        intro: 'Suggested structure; you can embed Qualtrics or link PDF.',
        item1: '<strong>Dice task module</strong> â€” Instructions, practice, reporting',
        item2: '<strong>Social norms</strong> â€” Descriptive/injunctive and meta-beliefs',
        item3: '<strong>Trust & institutions</strong> â€” Interpersonal, institutional, civic behaviors',
        item4: '<strong>Demographics</strong> â€” Age, gender, education, region',
        item5: '<strong>Country</strong> â€” IRB, translations, timings',
        version: 'Recommended versioning: <code>DICEâ€‘Q v1.2 (2025â€‘06â€‘10)</code>',
        btn1: 'Open Qualtrics (placeholder)',
        btn2: 'Download all Questionnaires',
        docsTitle: 'Individual questionnaires',
        docsNote: 'Download questionnaires by country.'
      },
      prereg: {
        title: 'Pre-registrations',
        btnAll: 'Download all preregistrations'
      },
      footer: {
        tagline: 'Norms & honesty in 34 countries',
        contact: 'Contact',
        status: 'Site status',
        updated: 'Last updated:'
      }
    },
    es: {
      nav: {
        subtitle: 'Experimento multicultural en aula',
        welcome: 'Bienvenida',
        implementation: 'ImplementaciÃ³n',
        collaborators: 'Colaboradores',
        projects: 'Proyectos',
        data: 'Datos',
        photos: 'Fotos',
        questionnaire: 'Cuestionarios',
        prereg: 'Preâ€‘registros'
      },
      hero: {
        title: 'Proyecto DICE',
        subtitle: 'Un experimento en aula, coordinado y armonizado, realizado en <strong>34 paÃ­ses</strong> para estudiar normas sociales y honestidad. La base de datos comÃºn alimenta <strong>14 proyectos</strong> que analizan mecanismos complementarios (capital cÃ­vico, confianza institucional, preferencias sociales y cumplimiento).',
        chip1: 'En aula',
        chip2: '34 paÃ­ses',
        chip3: 'Protocolo comÃºn',
        chip4: 'Materiales abiertos',
        chip5: '14 proyectos vinculados',
        kpi1: 'PaÃ­ses',
        kpi2: 'Proyectos vinculados',
        kpi3: 'Dataset & protocolo'
      },
      countries: {
        title: '34 PaÃ­ses participantes',
        titleSuffix: 'PaÃ­ses participantes',
        subtitle: 'Red global de investigaciÃ³n con representaciÃ³n en 5 continentes.',
        ARG: 'Argentina', AUT: 'Austria', CHL: 'Chile', CHN: 'China', CIV: 'CÃ´te d\'Ivoire',
        COD: 'R.D. del Congo', COL: 'Colombia', CZE: 'RepÃºblica Checa', DEU: 'Alemania', EGY: 'Egipto',
        ESP: 'EspaÃ±a', FRA: 'Francia', GBR: 'Reino Unido', GRC: 'Grecia', HKG: 'Hong Kong',
        HUN: 'HungrÃ­a', ITA: 'Italia', JPN: 'JapÃ³n', KAZ: 'KazajistÃ¡n', KOR: 'Corea del Sur',
        MDG: 'Madagascar', PAK: 'PakistÃ¡n', PER: 'PerÃº', PHL: 'Filipinas', POL: 'Polonia',
        PRT: 'Portugal', QAT: 'Catar', RUS: 'Rusia', SAU: 'Arabia Saudita', SGP: 'Singapur',
        TUR: 'TurquÃ­a', TWN: 'TaiwÃ¡n', URY: 'Uruguay', USA: 'Estados Unidos',
        legend: 'PaÃ­ses participantes (34)',
        note: 'Cobertura en AmÃ©rica, Europa, Asia, Ãfrica y OceanÃ­a'
      },
      countryDetails: {
        title: 'Equipos por paÃ­s',
        subtitle: 'InformaciÃ³n detallada de cada equipo de investigaciÃ³n participante.',
        team: 'Equipo:',
        institution: 'InstituciÃ³n:',
        city: 'Ciudad:',
        sample: 'Muestra:',
        observations: 'Observaciones:'
      },
      implementation: {
        title: 'Resumen de implementaciÃ³n',
        item1: '<strong>DiseÃ±o:</strong> Tarea del dado en aula con instrucciones armonizadas, supervisiÃ³n y tiempos estandarizados.',
        item2: '<strong>Muestra:</strong> Clases universitarias; N objetivo por paÃ­s segÃºn protocolo (sustituir con tus cifras).',
        item3: '<strong>Medidas clave:</strong> Reporte de resultados, proxies de honestidad, normas sociales, confianza, conductas cÃ­vicas y demografÃ­a.',
        item4: '<strong>Calidad:</strong> Preâ€‘registro, checklist de proctor, marcas de tiempo y validaciÃ³n centralizada.',
        item5: '<strong>Datos:</strong> Liberaciones por etapas (piloto â†’ v1.0 â†’ replicaciÃ³n) con guÃ­a de licencia y citaciÃ³n.',
        quickLinks: 'Accesos rÃ¡pidos',
        link1: 'Vista previa del cuestionario',
        link2: 'Registro de preâ€‘anÃ¡lisis',
        link3: 'Listado de proyectos',
        link4: 'Paquete de replicaciÃ³n (placeholder)',
        note: 'Sustituye los <em>placeholders</em> por enlaces a OSF/AEA/Dataverse/GitHub.'
      },
      collaborators: {
        title: 'Colaboradores',
        subtitle: 'Red global de investigadores/as, docentes y asistentes. AÃ±ade logotipos, nombres, roles e instituciones.',
        card1: {
          title: 'CoordinaciÃ³n',
          text: 'Investigador principal: <strong><a href="https://www.ub.edu/school-economics/researchers/exadaktylos-filippos/" target="_blank" style="color:inherit; text-decoration:none">Filippos Exadaktylos</a></strong> (ejemplo)',
          note: 'AÃ±ade coâ€‘IPs, gestiÃ³n de proyecto y contactos.'
        },
        card2: {
          title: 'Equipos por paÃ­s',
          text: 'Una tarjeta por paÃ­s con instituciÃ³n, PI(s), ciudad, nivel educativo y tamaÃ±o muestral.',
          viewall: 'â†’ Ver todos los 34 paÃ­ses'
        },
        card3: {
          title: 'MÃ©todos & QA',
          text: 'Autores del protocolo, arquitectura de encuesta y equipo de auditorÃ­a de datos.',
          tag1: 'Protocolo',
          tag2: 'Encuesta',
          tag3: 'AuditorÃ­a'
        },
        card4: {
          title: 'Socios & financiadores',
          text: 'Incluye nÃºmeros de beca, patrocinadores y alianzas institucionales.'
        }
      },
      projects: {
        title: 'Proyectos (14)',
        subtitle: 'Cada proyecto aprovecha una parte distinta del dataset comÃºn. A continuaciÃ³n, resÃºmenes breves y enlaces clave.',
        p1: { title: '1. Normas sociales & reporte', desc: 'RelaciÃ³n entre normas percibidas/metacreencias y conducta en la tarea del dado.' },
        p2: { title: '2. Capital cÃ­vico & confianza', desc: 'Conductas cÃ­vicas, confianza institucional y honestidad entre culturas.' },
        p3: { title: '3. Cumplimiento & polÃ­tica', desc: 'AceptaciÃ³n de reglas y correlatos de cumplimiento.' },
        p4: { title: '4. Dimensiones culturales', desc: 'Individualismo, universalismo y seguimiento de normas.' },
        p5: { title: '5. Instituciones & honestidad', desc: 'Calidad institucional e interacciones con proxies de honestidad.' },
        p6: { title: '6. Desigualdad & justicia', desc: 'Preferencias distributivas y cumplimiento de reglas.' },
        p7: { title: '7. EducaciÃ³n & cohortes', desc: 'Diferencias por edad y nivel educativo.' },
        p8: { title: '8. Urbano vs. regional', desc: 'GeografÃ­a, tipo de centro y normas.' },
        p9: { title: '9. GÃ©nero & normas', desc: 'Expectativas de gÃ©nero y honestidad.' },
        p10: { title: '10. ReplicaciÃ³n & mÃ©todos', desc: 'Potencia, identificaciÃ³n y robustez entre paÃ­ses.' },
        p11: { title: '11. Mensajes & creencias', desc: 'Tratamientos informativos y actualizaciÃ³n de normas.' },
        p12: { title: '12. Redes & spillovers', desc: 'Efectos de pares en el aula.' },
        p13: { title: '13. Ã‰tica & consentimiento', desc: 'Aprobaciones Ã©ticas y lenguaje de consentimiento.' },
        p14: { title: '14. CuraciÃ³n de datos', desc: 'EstandarizaciÃ³n documental y versionado.' },
        tag: {
          analysis: 'Plan de anÃ¡lisis',
          materials: 'Materiales',
          code: 'CÃ³digo',
          prereg: 'Preâ€‘reg',
          slides: 'Diapositivas',
          design: 'DiseÃ±o',
          results: 'Resultados',
          guide: 'GuÃ­a'
        }
      },
      data: {
        title: 'Datos',
        subtitle: 'Accede a nuestros datos de muestra del experimento DICE. Datos completos disponibles tras publicaciÃ³n.',
        card1: {
          title: 'Datos de muestra',
          desc: 'Dataset de ejemplo con 15 participantes de 5 paÃ­ses. Incluye resultados del dado, datos demogrÃ¡ficos y puntuaciones de confianza.',
          format: 'Formato:',
          size: 'TamaÃ±o:',
          updated: 'Actualizado:',
          btn: 'Descargar datos de muestra'
        },
        card2: {
          title: 'Estructura de datos',
          desc: 'El dataset incluye las siguientes variables:',
          var1: 'PaÃ­s del participante',
          var2: 'ID Ãºnico',
          var3: 'Resultado real del dado',
          var4: 'Valor reportado',
          var5: 'Fecha de sesiÃ³n',
          var6: 'Edad',
          var7: 'GÃ©nero',
          var8: 'PuntuaciÃ³n de confianza (1-10)'
        },
        card3: {
          title: 'Acceso al dataset completo',
          text: 'El dataset completo con datos de los 34 paÃ­ses estarÃ¡ disponible tras la publicaciÃ³n de los artÃ­culos principales. Se alojarÃ¡ en repositorios abiertos con DOI y licencia Creative Commons.',
          note: 'Para acceso anticipado o colaboraciones, contacta al <a href="https://www.ub.edu/school-economics/researchers/exadaktylos-filippos/" target="_blank" style="color:#60a5fa; text-decoration:none">equipo de coordinaciÃ³n</a>.'
        }
      },
      photos: {
        title: 'Fotos',
        subtitle: 'Sustituye con imÃ¡genes de aulas, talleres y equipos. (Marcadores de Picsum).'
      },
      questionnaire: {
        title: 'Cuestionario (vista previa)',
        intro: 'Estructura sugerida; puedes incrustar Qualtrics o enlazar PDF.',
        item1: '<strong>MÃ³dulo tarea del dado</strong> â€” Instrucciones, prÃ¡ctica, reporte',
        item2: '<strong>Normas sociales</strong> â€” Descriptivas/injuntivas y metacreencias',
        item3: '<strong>Confianza & instituciones</strong> â€” Interpersonal, institucional, conductas cÃ­vicas',
        item4: '<strong>DemografÃ­a</strong> â€” Edad, gÃ©nero, estudios, regiÃ³n',
        item5: '<strong>PaÃ­s</strong> â€” IRB, traducciones, tiempos',
        version: 'Versionado recomendado: <code>DICEâ€‘Q v1.2 (2025â€‘06â€‘10)</code>',
        btn1: 'Abrir Qualtrics (placeholder)',
        btn2: 'Descargar todos los cuestionarios',
        docsTitle: 'Cuestionarios individuales',
        docsNote: 'Descarga cuestionarios por paÃ­s.'
      },
      prereg: {
        title: 'Preâ€‘registros',
        btnAll: 'Descargar todos los preâ€‘registros'
      },
      footer: {
        tagline: 'Normas & honestidad en 34 paÃ­ses',
        contact: 'Contacto',
        status: 'Estado del sitio',
        updated: 'Ãšltima actualizaciÃ³n:'
      }
    }
  };

  // Update prereg list labels to actual project names (by language)
  function updatePreregLabels(){
    try {
      const lang = currentLang || (localStorage.getItem('lang') || 'es');
      const base = translations && translations[lang] && translations[lang].projects;
      if (!base) return;
      document.querySelectorAll('#prereg-box a.btn.secondary[href$="preregistration.pdf"]').forEach(a => {
        const href = a.getAttribute('href') || '';
        const m = href.match(/project-(\d+)/);
        if (!m) return;
        const idx = parseInt(m[1], 10);
        const key = 'p' + idx;
        const title = base[key] && base[key].title ? String(base[key].title) : '';
        const pretty = title.replace(/^\s*\d+\.\s*/, '').trim();
        if (pretty) a.textContent = pretty;
      });
    } catch (e) {
      console.warn('updatePreregLabels failed', e);
    }
  }

  // Theme switcher
  let currentTheme = localStorage.getItem('theme') || 'auto';

  function applyTheme(theme) {
    currentTheme = theme;
    localStorage.setItem('theme', theme);

    if (theme === 'auto') {
      // Follow system preference
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
    } else {
      document.documentElement.setAttribute('data-theme', theme);
    }

    // Update active theme button
    document.querySelectorAll('[data-theme-opt]').forEach(opt => {
      opt.classList.toggle('active', opt.getAttribute('data-theme-opt') === theme);
    });

    // Update map colors if map is loaded
    updateMapTheme();
  }

  // Listen for system theme changes when in auto mode
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (currentTheme === 'auto') {
      document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
      updateMapTheme();
    }
  });

  // Language switcher
  let currentLang = localStorage.getItem('lang') || 'es';

  function setLanguage(lang) {
    // Validate language exists in translations
    if (!translations[lang]) {
      console.warn(`Language '${lang}' not found, defaulting to 'es'`);
      lang = 'es';
    }

    currentLang = lang;
    localStorage.setItem('lang', lang);
    document.documentElement.setAttribute('lang', lang);

    // Update all elements with data-i18n
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      const keys = key.split('.');
      let value = translations[lang];
      keys.forEach(k => {
        if (value && typeof value === 'object') {
          value = value[k];
        }
      });
      if (value) el.innerHTML = value;
    });

    // Update nav links
    document.querySelectorAll('[data-i18n-nav]').forEach(el => {
      const key = el.getAttribute('data-i18n-nav');
      if (translations[lang] && translations[lang].nav && translations[lang].nav[key]) {
        el.textContent = translations[lang].nav[key];
      }
    });

    // Update active language button
    document.querySelectorAll('[data-lang]').forEach(opt => {
      opt.classList.toggle('active', opt.getAttribute('data-lang') === lang);
    });

    // Refresh preregistration labels to current language
    updatePreregLabels();
  }

  // Load preregistrations from projects data
  function loadPreregistrations() {
    // Number emojis for aesthetic
    const numberEmojis = ['0ï¸âƒ£', '1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ'];

    function getNumberEmoji(num) {
      if (num === 10) return 'ğŸ”Ÿ';
      if (num < 10) return numberEmojis[num];
      // For 11, 12, etc., use digit emojis
      return String(num).split('').map(digit => numberEmojis[parseInt(digit)]).join('');
    }

    fetch('projects-data.json')
      .then(response => response.json())
      .then(data => {
        const preregList = document.getElementById('prereg-list');
        if (!preregList) return;

        // Clear loading message
        preregList.innerHTML = '';

        // Generate preregistration links from projects
        data.projects.forEach(project => {
          const projectNum = String(project.id).padStart(2, '0');
          const link = document.createElement('a');
          link.href = `data/projects/project-${projectNum}/preregistration.pdf`;
          link.download = '';
          link.className = 'btn secondary';
          link.style.cssText = 'display:block; margin-bottom:8px; font-size:13px; padding:8px 12px; text-align:left;';
          link.textContent = `${getNumberEmoji(project.id)}  ${project.title}`;
          preregList.appendChild(link);
        });

        console.log(`Loaded ${data.projects.length} preregistrations`);
      })
      .catch(error => {
        console.error('Error loading preregistrations:', error);
        const preregList = document.getElementById('prereg-list');
        if (preregList) {
          preregList.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc2626;">Error loading preregistrations</div>';
        }
      });
  }

  // Initialize language and theme on page load
  document.addEventListener('DOMContentLoaded', () => {
    // Apply theme first (before rendering)
    applyTheme(currentTheme);

    // Theme toggle click handler
    document.querySelectorAll('[data-theme-opt]').forEach(opt => {
      opt.addEventListener('click', () => {
        applyTheme(opt.getAttribute('data-theme-opt'));
      });
    });

    setLanguage(currentLang);

    // Language toggle click handler
    document.querySelectorAll('[data-lang]').forEach(opt => {
      opt.addEventListener('click', () => {
        setLanguage(opt.getAttribute('data-lang'));
      });
    });

    // Load preregistrations
    loadPreregistrations();

    // Initial prereg label hydration
    updatePreregLabels();
  });

  // Last updated stamp
  document.getElementById('last-updated').textContent = new Date().toISOString().slice(0,10);

  // Toast helper
  window.showToast = function(message){
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = 'âœ“ ' + message;
    document.body.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('show'));
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 200);
    }, 3000);
  };
</script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- Zip libraries for bundling questionnaires -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
  // Initialize map
  const map = L.map('map', {
    center: [30, 0],
    zoom: 2,
    minZoom: 1,
    maxZoom: 6,
    scrollWheelZoom: false,
    zoomControl: true
  });

  // Add a base tile layer so the map is visible even if GeoJSON fails
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
    maxZoom: 19,
    subdomains: 'abcd'
  }).addTo(map);

  // Ensure proper sizing after load
  window.addEventListener('load', () => setTimeout(() => map.invalidateSize(), 0));

  // Load country data from JSON file
  let participatingCountryCodes = [];
  let countryData = {};
  let countriesLayer = null; // Store reference to update on theme change

  // Code alias mapping for countries that might have different codes in GeoJSON
  const codeAliases = {
    'SGP': ['SGP', 'SG', 'Singapore', '702'],
    'HKG': ['HKG', 'HK', 'Hong Kong', '344', 'CHN-HK'],
    'TWN': ['TWN', 'TW', 'Taiwan', '158', 'CHN-TW'],
    'FRA': ['FRA', 'FR', 'France']
  };

  // Map ISO2 to ISO3 codes for datasets that only have ISO2
  const iso2ToIso3 = {
    'FR': 'FRA', 'SG': 'SGP', 'HK': 'HKG', 'TW': 'TWN'
  };

  // Helper function to check if a code matches any of our countries (including aliases)
  function isParticipatingCountry(geoCode) {
    if (!geoCode) return false;

    // Direct match
    if (participatingCountryCodes.includes(geoCode)) {
      return geoCode;
    }

    // Check aliases
    for (const [ourCode, aliases] of Object.entries(codeAliases)) {
      if (participatingCountryCodes.includes(ourCode)) {
        if (aliases.some(alias => alias === geoCode || geoCode.includes(alias))) {
          return ourCode; // Return our standard code
        }
      }
    }

    return false;
  }

  // Get map colors based on current theme
  function getMapColors() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const isLight = currentTheme === 'light';

    return {
      participating: {
        fillColor: isLight ? '#D49D39' : '#193865',
        color: isLight ? '#c88d28' : '#D49D39',
        fillOpacity: isLight ? 0.7 : 0.85
      },
      nonParticipating: {
        fillColor: isLight ? '#e2e8f0' : '#0f172a',
        color: isLight ? '#cbd5e1' : '#1f2937',
        fillOpacity: isLight ? 0.5 : 0.3
      }
    };
  }

  // Update map styling when theme changes
  function updateMapTheme() {
    if (countriesLayer) {
      countriesLayer.eachLayer(function(layer) {
        const feature = layer.feature;
        if (feature && feature.properties) {
          const props = feature.properties;
          const countryName = props.name || props.ADMIN || props.admin || '';
          let countryCode = props['ISO3166-1-Alpha-3'] || props.ISO_A3 || props.iso_a3 || props.ADM0_A3 || props['Alpha-3'] || props.iso3 || props.ISO3 || feature.id;

          // Handle -99 codes
          if (countryCode === -99 || countryCode === '-99') {
            const iso2 = props['ISO3166-1-Alpha-2'];
            if (iso2 && iso2ToIso3[iso2]) {
              countryCode = iso2ToIso3[iso2];
            } else {
              countryCode = null;
            }
          }

          let matchedCode = isParticipatingCountry(countryCode);
          if (!matchedCode && countryName) {
            matchedCode = isParticipatingCountry(countryName);
          }

          const colors = getMapColors();
          const style = matchedCode ? colors.participating : colors.nonParticipating;

          layer.setStyle({
            fillColor: style.fillColor,
            weight: 0.8,
            opacity: 1,
            color: style.color,
            fillOpacity: style.fillOpacity
          });
        }
      });
    }
  }

  // First, load country data from JSON file
  fetch('country-data.json')
    .then(response => response.json())
    .then(data => {
      participatingCountryCodes = data.participatingCountryCodes;
      countryData = data.countryData;
      const countryCount = participatingCountryCodes.length;
      console.log('Country data loaded:', countryCount, 'countries');
      console.log('Participating country codes:', participatingCountryCodes);

      // Update all country count displays (with null checks)
      const heroCount = document.getElementById('hero-country-count');
      const chipCount = document.getElementById('chip-country-count');
      const sectionCount = document.getElementById('section-country-count');

      if (heroCount) heroCount.textContent = countryCount;
      if (chipCount) chipCount.textContent = countryCount;
      if (sectionCount) sectionCount.textContent = countryCount;

      // After country data is loaded, load world countries GeoJSON
      // Using Natural Earth data which includes Singapore, Hong Kong, and all territories
      return fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson');
    })
    .then(response => {
      console.log('Fetch response:', response);
      return response.json();
    })
    .then(data => {
      console.log('GeoJSON loaded, features:', data.features.length);

      // Log first feature's properties to understand structure
      if (data.features.length > 0) {
        console.log('Sample feature properties:', data.features[0].properties);
      }

      // Log ALL country codes in GeoJSON to find Singapore and Hong Kong
      const allGeoCodes = [];
      data.features.forEach(feature => {
        const props = feature && feature.properties ? feature.properties : {};
        let countryCode = props['ISO3166-1-Alpha-3'] || props.ISO_A3 || props.iso_a3 || props.ADM0_A3 || props['Alpha-3'] || props.iso3 || props.ISO3 || feature.id;

        // If we got -99 (invalid), try ISO2 code and convert to ISO3
        if (countryCode === -99 || countryCode === '-99') {
          const iso2 = props['ISO3166-1-Alpha-2'];
          if (iso2 && iso2ToIso3[iso2]) {
            countryCode = iso2ToIso3[iso2];
          }
        }

        const countryName = props.name || props.ADMIN || props.admin || '';
        if (countryCode && !allGeoCodes.includes(countryCode)) {
          allGeoCodes.push(countryCode);
        }
        // Look for Singapore and Hong Kong specifically
        if (countryName && countryName.toLowerCase().includes('sing')) {
          console.log('ğŸ” Found Singapore-like:', countryName, '- Code:', countryCode);
        }
        if (countryName && countryName.toLowerCase().includes('hong')) {
          console.log('ğŸ” Found Hong Kong-like:', countryName, '- Code:', countryCode);
        }
      });
      console.log('ğŸ“‹ All GeoJSON codes:', allGeoCodes.sort().join(', '));

      let highlightedCount = 0;

      countriesLayer = L.geoJSON(data, {
        style: function(feature) {
          const props = feature && feature.properties ? feature.properties : {};
          const countryName = props.name || props.ADMIN || props.admin || '';

          // Try multiple property names for ISO3 code
          let countryCode = props['ISO3166-1-Alpha-3'] ||
                             props.ISO_A3 ||
                             props.iso_a3 ||
                             props.ADM0_A3 ||
                             props['Alpha-3'] ||
                             props.iso3 ||
                             props.ISO3 ||
                             feature.id;

          // If we got -99 (invalid), try ISO2 code and convert to ISO3
          if (countryCode === -99 || countryCode === '-99') {
            const iso2 = props['ISO3166-1-Alpha-2'];
            if (iso2 && iso2ToIso3[iso2]) {
              countryCode = iso2ToIso3[iso2];
            } else {
              countryCode = null; // Force fallback to name matching
            }
          }

          // Check both the code and country name for matches (handles aliases)
          let matchedCode = isParticipatingCountry(countryCode);
          if (!matchedCode && countryName) {
            matchedCode = isParticipatingCountry(countryName);
          }

          // Debug: Log Singapore, Hong Kong, and France specifically
          if (countryName && (countryName.toLowerCase().includes('singapore') || countryName.toLowerCase().includes('hong kong') || countryName.toLowerCase().includes('france'))) {
            console.log('ğŸ” DEBUG:', countryName, '- GeoCode:', countryCode, '- Matched:', matchedCode, '- All props:', Object.keys(props));
          }

          if (matchedCode) {
            highlightedCount++;
            console.log('âœ“ Highlighting:', countryName, '(' + countryCode + ') â†’ matched as', matchedCode);
          }

          const colors = getMapColors();
          const style = matchedCode ? colors.participating : colors.nonParticipating;

          return {
            fillColor: style.fillColor,
            weight: 0.8,
            opacity: 1,
            color: style.color,
            fillOpacity: style.fillOpacity
          };
        },
        onEachFeature: function(feature, layer) {
          const props = feature && feature.properties ? feature.properties : {};
          const countryName = props.name || props.ADMIN || props.admin || '';

          // Try multiple property names for ISO3 code (same as in style function)
          let countryCode = props['ISO3166-1-Alpha-3'] ||
                             props.ISO_A3 ||
                             props.iso_a3 ||
                             props.ADM0_A3 ||
                             props['Alpha-3'] ||
                             props.iso3 ||
                             props.ISO3 ||
                             feature.id;

          // If we got -99 (invalid), try ISO2 code and convert to ISO3
          if (countryCode === -99 || countryCode === '-99') {
            const iso2 = props['ISO3166-1-Alpha-2'];
            if (iso2 && iso2ToIso3[iso2]) {
              countryCode = iso2ToIso3[iso2];
            } else {
              countryCode = null; // Force fallback to name matching
            }
          }

          // Check both the code and country name for matches (handles aliases)
          let matchedCode = isParticipatingCountry(countryCode);
          if (!matchedCode && countryName) {
            matchedCode = isParticipatingCountry(countryName);
          }

          if (matchedCode) {
            const country = countryData[matchedCode];

            // Bind tooltip that shows on hover with full details
            const tooltipContent = `
              <div style="min-width:250px">
                <div style="font-size:18px; margin-bottom:6px">${country.flag} <strong>${country.name}</strong></div>
                <div style="font-size:11px; color:#94a3b8; margin-bottom:4px">Team:</div>
                <div style="font-size:12px; margin-bottom:6px">${country.team}</div>
                <div style="font-size:11px; color:#94a3b8; margin-bottom:4px">Institution:</div>
                <div style="font-size:12px; margin-bottom:6px">${country.institution}</div>
                <div style="font-size:11px; color:#60a5fa">${country.sample} â€¢ Click for details</div>
              </div>
            `;

            layer.bindTooltip(tooltipContent, {
              permanent: false,
              direction: 'top',
              className: 'country-tooltip',
              opacity: 0.95,
              offset: [0, -10]
            });

            // Add click handler to navigate to countries.html page
            layer.on('click', function(e) {
              if (country.anchor) {
                // Navigate immediately without adding highlight
                window.location.href = `countries.html#${country.anchor}`;
              }
            });

            // Add hover effect and cursor pointer
            layer.on({
              mouseover: function(e) {
                const l = e.target;
                l.setStyle({ fillOpacity: 0.95, fillColor: '#60a5fa', cursor: 'pointer' });
              },
              mouseout: function(e) {
                countriesLayer.resetStyle(e.target);
              }
            });
          }
        }
      }).addTo(map);

      console.log(`Map loaded successfully - ${highlightedCount} countries highlighted`);
    })
    .catch(error => {
      console.error('Error loading map data:', error);
      const el = document.getElementById('map');
      if (el) {
        const msg = document.createElement('div');
        msg.style.cssText = 'position:absolute; top:10px; left:10px; background:rgba(0,0,0,.6); color:#fff; padding:8px 10px; border-radius:8px; font-size:12px; z-index:5;';
        msg.textContent = 'Error loading map data. Please ensure you are running a local server.';
        el.appendChild(msg);
      }
    });
</script>

<script>
  // Download all questionnaires as a zip
  document.addEventListener('DOMContentLoaded', () => {
    const downloadBtn = document.getElementById('download-all-questionnaires');
    if (!downloadBtn) return;

    downloadBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        if (typeof JSZip === 'undefined') {
          alert('Zip library not loaded. Please try again.');
          return;
        }

        const box = document.getElementById('questionaries-box');
        const links = box ? Array.from(box.querySelectorAll('a.btn.secondary[href$="questionnaire.pdf"]')) : [];
        if (links.length === 0) {
          alert('No questionnaires found to download.');
          return;
        }

        downloadBtn.textContent = 'Preparing zipâ€¦';
        downloadBtn.setAttribute('aria-busy', 'true');
        downloadBtn.disabled = true;

        const zip = new JSZip();
        const folder = zip.folder('questionnaires');

        const toSafeName = (label) => (label || '')
          .replace(/^[^\p{L}\p{N}]+|[^\p{L}\p{N}]+$/gu, '')
          .replace(/[^\p{L}\p{N}]+/gu, ' ')
          .trim();

        const toFilename = (href) => {
          try {
            const url = new URL(href, window.location.href);
            const parts = url.pathname.split('/').filter(Boolean);
            const country = parts[parts.indexOf('countries') + 1] || 'country';
            return country + '.pdf';
          } catch {
            return 'questionnaire.pdf';
          }
        };

        for (const a of links) {
          const href = a.getAttribute('href');
          const label = toSafeName((a.textContent || '').trim());
          const filename = (label ? label + ' - questionnaire.pdf' : toFilename(href));
          try {
            const resp = await fetch(href);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const blob = await resp.blob();
            const arrayBuffer = await blob.arrayBuffer();
            folder.file(filename, arrayBuffer);
          } catch (err) {
            console.warn('Skipping', href, err);
          }
        }

        const content = await zip.generateAsync({ type: 'blob' });
        if (typeof saveAs !== 'undefined') {
          saveAs(content, 'DICE-questionnaires.zip');
          if (typeof showToast === 'function') showToast('You successfully downloaded questionnaire for all countries');
        } else {
          // Fallback
          const url = URL.createObjectURL(content);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'DICE-questionnaires.zip';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          if (typeof showToast === 'function') showToast('You successfully downloaded questionnaire for all countries');
        }
      } catch (err) {
        console.error(err);
        alert('There was an error creating the zip. Please try again.');
      } finally {
        downloadBtn.removeAttribute('aria-busy');
        downloadBtn.disabled = false;
        // Restore i18n label if available, else keep text
        const lang = (window.localStorage && localStorage.getItem('lang')) || 'es';
        const t = (window.translations && translations[lang] && translations[lang].questionnaire && translations[lang].questionnaire.btn2) || 'Download all Questionaires';
        downloadBtn.textContent = t;
      }
    });
  });
</script>

<script>
  // Load and display projects from JSON file
  document.addEventListener('DOMContentLoaded', () => {
    fetch('projects-data.json')
      .then(response => response.json())
      .then(data => {
        const projectCount = data.projectCount;
        const projects = data.projects;

        // Update project count
        const countEl = document.getElementById('project-count');
        if (countEl) {
          countEl.textContent = projectCount;
        }

        // Get projects grid container
        const grid = document.getElementById('projects-grid');
        if (!grid) return;

        // Clear loading message
        grid.innerHTML = '';

        // Generate project cards
        projects.forEach(project => {
          const card = document.createElement('div');
          card.className = 'proj';

          // Create title with status badge
          const titleEl = document.createElement('h4');
          const statusBadge = project.status === 'CLOSED'
            ? '<span style="display:inline-block; margin-right:6px; padding:2px 6px; background:#dc2626; color:white; border-radius:4px; font-size:9px; font-weight:600; vertical-align:middle;">CLOSED</span>'
            : '';
          titleEl.innerHTML = `${project.id}. ${statusBadge}${project.title}`;
          card.appendChild(titleEl);

          // Create authors list
          const authorsEl = document.createElement('p');
          authorsEl.className = 'small';
          authorsEl.style.color = '#64748b';
          authorsEl.style.marginBottom = '8px';

          // Show first 3 authors, then "and X more"
          const displayAuthors = project.allAuthors.slice(0, 3);
          const remainingCount = project.authorCount - 3;
          const authorsText = displayAuthors.join(', ') +
            (remainingCount > 0 ? ` <em>and ${remainingCount} more</em>` : '');
          authorsEl.innerHTML = '<strong>Authors:</strong> ' + authorsText;
          card.appendChild(authorsEl);

          // Add tags container (placeholder for now)
          const tagsEl = document.createElement('div');
          tagsEl.style.marginTop = '8px';
          card.appendChild(tagsEl);

          grid.appendChild(card);
        });

        console.log(`Loaded ${projectCount} projects successfully`);
      })
      .catch(error => {
        console.error('Error loading projects:', error);
        const grid = document.getElementById('projects-grid');
        if (grid) {
          grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #dc2626;"><div style="font-size: 14px;">Error loading projects. Please ensure projects-data.json exists and you are running a local server.</div></div>';
        }
      });
  });
</script>

<script>
  // Download all preregistrations as a zip
  document.addEventListener('DOMContentLoaded', () => {
    const downloadBtn = document.getElementById('download-all-prereg');
    if (!downloadBtn) return;

    downloadBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        if (typeof JSZip === 'undefined') {
          alert('Zip library not loaded. Please try again.');
          return;
        }

        const box = document.getElementById('prereg-box');
        const links = box ? Array.from(box.querySelectorAll('a.btn.secondary[href$="preregistration.pdf"]')) : [];
        if (links.length === 0) {
          alert('No preregistration files found to download.');
          return;
        }

        const originalText = downloadBtn.textContent;
        downloadBtn.textContent = 'Preparing zipâ€¦';
        downloadBtn.setAttribute('aria-busy', 'true');
        downloadBtn.disabled = true;

        const zip = new JSZip();
        const folder = zip.folder('preregistrations');

        const toSafeName = (label) => (label || '')
          .replace(/^[^\p{L}\p{N}]+|[^\p{L}\p{N}]+$/gu, '')
          .replace(/[^\p{L}\p{N}]+/gu, ' ')
          .trim();

        const toFilename = (href) => {
          try {
            const url = new URL(href, window.location.href);
            const parts = url.pathname.split('/').filter(Boolean);
            const proj = parts[parts.indexOf('projects') + 1] || 'project';
            return proj + '.pdf';
          } catch {
            return 'preregistration.pdf';
          }
        };

        for (const a of links) {
          const href = a.getAttribute('href');
          const label = toSafeName((a.textContent || '').trim());
          const filename = (label ? label + ' - preregistration.pdf' : toFilename(href));
          try {
            const resp = await fetch(href);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const blob = await resp.blob();
            const arrayBuffer = await blob.arrayBuffer();
            folder.file(filename, arrayBuffer);
          } catch (err) {
            console.warn('Skipping', href, err);
          }
        }

        const content = await zip.generateAsync({ type: 'blob' });
        if (typeof saveAs !== 'undefined') {
          saveAs(content, 'DICE-preregistrations.zip');
          if (typeof showToast === 'function') showToast('You successfully downloaded preregistration for all projects');
        } else {
          const url = URL.createObjectURL(content);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'DICE-preregistrations.zip';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          if (typeof showToast === 'function') showToast('You successfully downloaded preregistration for all projects');
        }
      } catch (err) {
        console.error(err);
        alert('There was an error creating the zip. Please try again.');
      } finally {
        downloadBtn.removeAttribute('aria-busy');
        downloadBtn.disabled = false;
        const lang = (window.localStorage && localStorage.getItem('lang')) || 'es';
        const fallback = 'Download all preregistrations';
        const t = (window.translations && translations[lang] && translations[lang].prereg && translations[lang].prereg.btnAll) || fallback;
        downloadBtn.textContent = t;
      }
    });
  });
</script>

<script>
  // Intercept individual downloads to show success toast after fetch+save
  document.addEventListener('DOMContentLoaded', () => {
    function handleDirectDownloads(selector, typeLabel){
      document.querySelectorAll(selector).forEach(a => {
        a.addEventListener('click', async (e) => {
          e.preventDefault();
          const href = a.getAttribute('href');
          const label = (a.textContent || '').trim();
          try {
            const resp = await fetch(href);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const blob = await resp.blob();
            const rawLabel = (label || '').replace(/^[^\p{L}\p{N}]+|[^\p{L}\p{N}]+$/gu, '').replace(/[^\p{L}\p{N}]+/gu, ' ').trim();
            const filename = (rawLabel ? `${rawLabel} - ${typeLabel}.pdf` : (href.split('/').pop() || 'download.pdf'));
            if (typeof saveAs !== 'undefined') {
              saveAs(blob, filename);
            } else {
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = filename;
              document.body.appendChild(link);
              link.click();
              link.remove();
              URL.revokeObjectURL(url);
            }
            if (typeof showToast === 'function') showToast(`You successfully downloaded ${typeLabel} for ${label}`);
          } catch (err) {
            console.error('Download failed:', href, err);
            alert('Failed to download. Please try again.');
          }
        });
      });
    }

    handleDirectDownloads('#questionaries-box a.btn.secondary[href$="questionnaire.pdf"]', 'questionnaire');
    handleDirectDownloads('#prereg-box a.btn.secondary[href$="preregistration.pdf"]', 'preregistration');
    });
</script>
</body>
</html>
